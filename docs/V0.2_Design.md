# prokaryote-agent V0.2 设计文档

**AI驱动的能力扩展模块（变异模块重新定义）**

---

## 一、设计理念

将原PRD中的"微小变异"概念重新诠释为**AI驱动的能力扩展**：
- 原核生物的"基因突变" → Agent的"能力生成"
- 人类预设要求 → 用户指引输入
- 环境适应 → 功能需求响应
- 变异筛选 → 能力评估

## 二、核心目标

**V0.2核心能力**：通过外部AI大模型，根据用户指引，为Agent动态生成和集成新功能。

**设计原则**：
1. **安全优先**：所有生成代码在沙箱中测试
2. **核心隔离**：不允许修改核心模块（init/monitor/repair）
3. **可控扩展**：用户完全掌控能力的启用/禁用
4. **渐进增强**：从简单功能开始（文件读取、数据处理等）

## 三、架构设计

### 3.1 总体架构（在V0.1基础上扩展）

```
┌─────────────────────────────────────────────┐
│         外部接口层 (api.py)                    │
│  init / start / stop / query                │
│  + generate_capability (新增)                │
│  + manage_capabilities (新增)                │
└────────────────┬────────────────────────────┘
                 │
┌────────────────┴────────────────────────────┐
│              核心模块层                        │
│  ┌──────────┬──────────┬──────────┐         │
│  │  Init    │ Monitor  │  Repair  │ (V0.1) │
│  └──────────┴──────────┴──────────┘         │
│  ┌──────────────────────────────────┐       │
│  │  Capability Generator (V0.2新增)  │       │
│  │  - AI Adapter                    │       │
│  │  - Code Generator                │       │
│  │  - Sandbox Runner                │       │
│  │  - Capability Manager            │       │
│  └──────────────────────────────────┘       │
└────────────────┬────────────────────────────┘
                 │
┌────────────────┴────────────────────────────┐
│          存储层 (storage.py)                  │
│  + capabilities/ 目录（新增）                 │
│    - generated_code/                        │
│    - capability_registry.json               │
└─────────────────────────────────────────────┘
```

### 3.2 模块职责

#### 1. AI Adapter（ai_adapter.py）
**职责**：统一的AI服务接口
- 支持多种大模型（OpenAI、Claude、国内模型）
- Prompt工程（代码生成专用模板）
- API调用管理（限流、重试、错误处理）
- 响应解析和验证

#### 2. Capability Generator（capability_generator.py）
**职责**：根据用户指引生成功能代码
- 需求解析：理解用户的功能描述
- 代码生成：调用AI生成Python代码
- 依赖检测：识别需要的第三方库
- 安全检查：检测危险操作（文件删除、系统调用等）

#### 3. Sandbox Runner（sandbox.py）
**职责**：隔离环境测试新功能
- 进程隔离：独立进程运行生成代码
- 资源限制：CPU、内存、时间限制
- 文件系统限制：仅允许访问特定目录
- 网络限制：可选的网络访问控制

#### 4. Capability Manager（capability_manager.py）
**职责**：管理所有扩展能力
- 注册表维护：记录所有已生成能力
- 生命周期管理：启用/禁用/卸载
- 依赖管理：处理能力间依赖关系
- 版本控制：支持能力更新

## 四、数据结构设计

### 4.1 能力注册表（capability_registry.json）

```json
{
  "capabilities": [
    {
      "id": "cap_001",
      "name": "file_reader",
      "description": "读取指定文件内容",
      "version": "1.0.0",
      "status": "enabled",
      "created_at": "2026-02-03T10:00:00",
      "updated_at": "2026-02-03T10:00:00",
      "user_guidance": "需要一个读取文本文件的功能",
      "code_path": "./capabilities/generated_code/file_reader.py",
      "entry_function": "read_file",
      "dependencies": [],
      "test_passed": true,
      "performance": {
        "avg_execution_time_ms": 50,
        "memory_usage_mb": 10,
        "success_rate": 0.99
      },
      "safety_level": "safe"
    }
  ],
  "last_update": "2026-02-03T10:00:00",
  "total_count": 1
}
```

### 4.2 能力代码模板

```python
# capabilities/generated_code/file_reader.py
"""
Capability: file_reader
Generated by: prokaryote-agent v0.2
User Guidance: 需要一个读取文本文件的功能
"""

import os
from typing import Dict, Any


def read_file(file_path: str) -> Dict[str, Any]:
    """
    读取文本文件内容
    
    Args:
        file_path: 文件路径
        
    Returns:
        dict: {"success": bool, "content": str, "error": str}
    """
    try:
        if not os.path.exists(file_path):
            return {
                "success": False,
                "content": "",
                "error": f"文件不存在: {file_path}"
            }
        
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
        
        return {
            "success": True,
            "content": content,
            "error": ""
        }
    except Exception as e:
        return {
            "success": False,
            "content": "",
            "error": str(e)
        }


# 能力元数据
CAPABILITY_METADATA = {
    "name": "file_reader",
    "version": "1.0.0",
    "description": "读取指定文件内容",
    "entry_function": "read_file",
    "required_permissions": ["file_read"]
}
```

## 五、工作流程

### 5.1 能力生成流程

```
用户输入指引
    ↓
需求解析 (AI Adapter)
    ↓
代码生成 (Capability Generator)
    ↓
安全检查 (代码扫描)
    ↓
沙箱测试 (Sandbox Runner)
    ↓
    ├─ 测试通过 → 注册能力 (Capability Manager)
    └─ 测试失败 → 返回错误，重新生成
```

### 5.2 能力调用流程

```
用户调用能力
    ↓
查找能力 (Capability Manager)
    ↓
检查状态 (enabled?)
    ↓
执行能力代码
    ↓
记录性能数据
    ↓
返回结果
```

## 六、安全机制

### 6.1 代码生成安全

**Prompt设计**：
- 明确禁止生成危险代码
- 要求使用标准库优先
- 限制文件系统操作范围

**代码扫描**：
- 检测 `os.system`、`subprocess`等危险调用
- 检测文件删除操作
- 检测网络请求（可选允许）

### 6.2 沙箱安全

**资源限制**：
- CPU时间：最多5秒
- 内存：最多100MB
- 文件访问：仅限 `capabilities/sandbox/` 目录

**进程隔离**：
- 使用 `multiprocessing` 独立进程
- 设置超时自动终止
- 捕获所有异常

## 七、API设计

### 7.1 新增外部接口

```python
def generate_capability(guidance: str, 
                       ai_provider: str = "openai",
                       test_mode: bool = True) -> Dict[str, Any]:
    """
    根据用户指引生成新能力
    
    Args:
        guidance: 用户描述的功能需求
        ai_provider: AI服务提供商（openai/claude/...）
        test_mode: 是否在沙箱中测试
        
    Returns:
        dict: {
            "success": bool,
            "capability_id": str,
            "capability_name": str,
            "test_results": dict,
            "message": str
        }
    """
    pass


def manage_capabilities(action: str, 
                       capability_id: str = None) -> Dict[str, Any]:
    """
    管理已生成的能力
    
    Args:
        action: 操作类型（list/enable/disable/remove/info）
        capability_id: 能力ID（某些操作需要）
        
    Returns:
        dict: 操作结果
    """
    pass


def invoke_capability(capability_name: str, 
                     params: Dict[str, Any]) -> Dict[str, Any]:
    """
    调用已注册的能力
    
    Args:
        capability_name: 能力名称
        params: 调用参数
        
    Returns:
        dict: 能力执行结果
    """
    pass
```

## 八、配置扩展

### 8.1 config.json 新增配置

```json
{
  "version": "0.2.0",
  "base_config": {
    // ... V0.1配置保持不变
  },
  "capability_config": {
    "ai_provider": "openai",
    "api_key": "${OPENAI_API_KEY}",
    "model": "gpt-4",
    "max_tokens": 2000,
    "temperature": 0.7,
    "sandbox_enabled": true,
    "sandbox_timeout_seconds": 5,
    "sandbox_memory_limit_mb": 100,
    "auto_enable": false,
    "allowed_operations": ["file_read", "data_process"],
    "forbidden_operations": ["file_delete", "system_exec"]
  },
  "storage_path": {
    // ... V0.1路径保持不变
    "capability_path": "./prokaryote_agent/capabilities/"
  }
}
```

## 九、开发计划

### Phase 1: AI Adapter（任务2）
- 实现OpenAI接口
- 设计Prompt模板
- 添加错误处理

### Phase 2: Capability Generator（任务3）
- 需求解析
- 代码生成
- 基础安全检查

### Phase 3: Sandbox（任务4）
- 进程隔离
- 资源限制
- 安全测试

### Phase 4: Capability Manager（任务5）
- 注册表管理
- 生命周期控制
- 性能监控

### Phase 5: 集成测试（任务7）
- 端到端测试
- 文档更新
- 示例代码

## 十、使用示例

### 示例1：生成文件读取能力

```python
from prokaryote_agent import generate_capability, invoke_capability

# 生成能力
result = generate_capability(
    guidance="我需要一个读取文本文件的功能，支持指定编码"
)

if result['success']:
    cap_id = result['capability_id']
    print(f"能力生成成功: {cap_id}")
    
    # 调用能力
    output = invoke_capability(
        capability_name="file_reader",
        params={"file_path": "test.txt", "encoding": "utf-8"}
    )
    print(output['content'])
```

### 示例2：管理能力

```python
from prokaryote_agent import manage_capabilities

# 列出所有能力
caps = manage_capabilities(action="list")
for cap in caps['capabilities']:
    print(f"{cap['name']}: {cap['status']}")

# 禁用某个能力
manage_capabilities(action="disable", capability_id="cap_001")
```

## 十一、风险与限制

### 风险
1. **AI生成代码不可控**：可能生成低质量或危险代码
2. **资源消耗**：AI调用和沙箱测试消耗资源
3. **API费用**：外部AI服务调用产生费用

### 应对措施
1. 严格的代码扫描和沙箱测试
2. 资源限制和超时控制
3. 本地缓存和批处理优化

### V0.2限制
- 仅支持Python代码生成
- 能力间不能相互调用（V0.3+）
- 不支持能力自动更新（V0.3+）

---

**文档版本**: V1.0  
**创建时间**: 2026-02-03  
**更新时间**: 2026-02-03
