# 知识进化系统设计

## 一、核心问题

当前系统的"训练"只是：
1. 执行固定任务（循环3个案例类型）
2. 搜索结果丢弃（没有存入知识库）
3. 等级只是数字增加（技能代码不变）
4. 没有能力提升的实际体现

## 二、设计目标

### 2.1 知识固化
- 训练过程中获取的信息**自动存入知识库**
- 技能执行时**优先查询本地知识库**，再补充网络搜索
- 知识具有**质量评分**和**使用统计**

### 2.2 能力进化
- 等级提升时**重新生成更强的技能代码**（通过核心酶）
- 高等级技能有**更多能力**和**更优实现**
- 技能代码**版本管理**，记录每次升级

### 2.3 训练多样化
- **递进式难度**：初级简单任务 → 高级复杂任务
- **随机化任务**：避免重复相同训练
- **评估反馈**：记录执行质量，指导改进方向

## 三、系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    训练循环 (Training Loop)                  │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐  │
│  │ 获取任务 │ → │ 执行技能 │ → │ 固化知识 │ → │ 评估结果 │  │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘  │
│        ↓              ↓              ↓              ↓       │
│   难度递进        知识库优先       自动存储       升级决策   │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│                    升级流程 (Upgrade Flow)                   │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐  │
│  │ 检查条件 │ → │ 确定增强 │ → │ 重新生成 │ → │ 验证部署 │  │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘  │
│   熟练度≥阈值    能力+功能+优化    核心酶生成    语法+测试   │
└─────────────────────────────────────────────────────────────┘
```

## 四、详细设计

### 4.1 知识固化机制

#### 4.1.1 技能执行时的知识流

```python
def execute(self, **kwargs):
    # 1. 优先查询本地知识库
    local_results = knowledge_base.search(query, domain=self.domain)
    
    # 2. 如果本地知识不足，进行网络搜索
    if len(local_results) < min_required:
        web_results = web_search(query)
        
        # 3. 将有价值的结果存入知识库
        for result in web_results:
            if self._is_valuable(result):
                knowledge_base.store_from_search(
                    title=result['title'],
                    content=result['content'],
                    domain=self.domain,
                    category=self._determine_category(result),
                    acquired_by=self.skill_id
                )
        
        # 合并结果
        all_results = local_results + web_results
    else:
        all_results = local_results
    
    # 4. 使用知识完成任务
    result = self._process_with_knowledge(all_results)
    return result
```

#### 4.1.2 知识质量评估

| 维度 | 权重 | 评估方式 |
|------|------|----------|
| 来源可信度 | 30% | 官方网站 > 百科 > 一般网页 |
| 内容完整度 | 25% | 长度、结构、引用 |
| 使用频率 | 25% | 被引用次数 |
| 时效性 | 20% | 发布/更新时间 |

### 4.2 能力进化机制

#### 4.2.1 等级与能力对应

| 等级范围 | 能力特征 | 代码变化 |
|----------|----------|----------|
| Lv.1-5 | 基础框架 | 模板生成，基本功能 |
| Lv.6-10 | 增强处理 | 添加批量处理、错误恢复 |
| Lv.11-15 | 知识驱动 | 优先使用知识库，缓存机制 |
| Lv.16-20 | 高级分析 | 多维度分析，质量评估 |
| Lv.20+ | 精通 | 自适应策略，性能优化 |

#### 4.2.2 升级时代码重新生成

```python
def upgrade_skill(skill_id: str, current_level: int, target_level: int):
    # 1. 确定新能力
    new_capabilities = get_level_capabilities(target_level)
    
    # 2. 构建增强规格
    enhanced_spec = {
        'id': skill_id,
        'level': target_level,
        'capabilities': new_capabilities,
        'enhancements': [
            'knowledge_integration' if target_level >= 11 else None,
            'batch_processing' if target_level >= 6 else None,
            'quality_scoring' if target_level >= 16 else None,
        ]
    }
    
    # 3. 调用核心酶重新生成代码
    result = skill_pipeline.generate(enhanced_spec)
    
    # 4. 保存新版本，记录变更
    save_skill_code(skill_id, result['code'], version=f"1.0.{target_level}")
```

#### 4.2.3 版本管理

```
skills/library/
├── case_analysis_basic.py           # 当前版本
├── .versions/
│   ├── case_analysis_basic_v1.0.1.py  # Lv.1 版本
│   ├── case_analysis_basic_v1.0.5.py  # Lv.5 版本 (添加批量)
│   ├── case_analysis_basic_v1.0.10.py # Lv.10 版本 (添加缓存)
│   └── case_analysis_basic_v1.0.15.py # Lv.15 版本 (知识驱动)
```

### 4.3 训练任务系统

#### 4.3.1 任务难度分级

```python
TRAINING_TASKS = {
    'case_analysis': {
        'easy': [  # Lv.1-5
            {'name': '单一案例分析', 'case_count': 1, 'complexity': 'simple'},
            {'name': '简单合同纠纷', 'case_type': 'contract', 'focus': 'basic'},
        ],
        'medium': [  # Lv.6-10
            {'name': '对比案例分析', 'case_count': 2, 'complexity': 'compare'},
            {'name': '多因素劳动争议', 'case_type': 'labor', 'focus': 'multi_factor'},
        ],
        'hard': [  # Lv.11-15
            {'name': '复杂侵权分析', 'case_type': 'tort', 'factors': ['liability', 'damages', 'causation']},
            {'name': '跨领域案例', 'case_types': ['contract', 'tort'], 'focus': 'integration'},
        ],
        'expert': [  # Lv.16-20
            {'name': '案例集成报告', 'case_count': 5, 'output': 'comprehensive_report'},
            {'name': '法律风险评估', 'scope': 'full_analysis', 'include_recommendations': True},
        ]
    }
}
```

#### 4.3.2 训练评估维度

| 维度 | 描述 | 权重 |
|------|------|------|
| 完成度 | 是否完成所有要求 | 40% |
| 准确性 | 结果是否正确 | 30% |
| 知识利用 | 是否有效使用知识库 | 15% |
| 效率 | 执行时间、资源使用 | 15% |

### 4.4 熟练度模型

```python
class ProficiencyModel:
    """熟练度模型 - 决定是否可以升级"""
    
    # 升级所需熟练度（0-1）
    LEVEL_THRESHOLDS = {
        (1, 5): 0.3,    # 初级：完成3次训练
        (6, 10): 0.4,   # 中级：需要更多练习
        (11, 15): 0.5,  # 高级：需要稳定表现
        (16, 20): 0.6,  # 专家：需要优秀表现
    }
    
    def can_upgrade(self, skill) -> bool:
        threshold = self.get_threshold(skill.level)
        return skill.proficiency >= threshold
    
    def update_proficiency(self, skill, task_result):
        """根据训练结果更新熟练度"""
        base_gain = 0.05
        
        # 难度加成
        difficulty_bonus = task_result.difficulty * 0.02
        
        # 知识贡献加成
        knowledge_bonus = task_result.knowledge_stored * 0.01
        
        # 质量加成/惩罚
        quality_factor = task_result.score - 0.5  # -0.5 to +0.5
        
        total_gain = base_gain + difficulty_bonus + knowledge_bonus + (quality_factor * 0.1)
        skill.proficiency = min(1.0, skill.proficiency + total_gain)
```

## 五、实现计划

### 阶段1：知识固化 (P0)
1. 修改技能模板，集成知识库调用
2. 在 skill_generator 中实现知识存储逻辑
3. 添加知识质量评估

### 阶段2：能力进化 (P1)
1. 设计等级能力映射表
2. 实现升级时代码重新生成
3. 添加版本管理

### 阶段3：训练增强 (P2)
1. 扩展训练任务库
2. 实现难度递进
3. 添加评估反馈

## 六、成功指标

| 指标 | 目标 | 测量方式 |
|------|------|----------|
| 知识积累 | 每次训练存储 ≥1 条知识 | 检查知识库文件数 |
| 知识复用 | 50%+ 任务使用本地知识 | 日志统计 |
| 代码进化 | 升级后代码行数 +10% | 代码对比 |
| 能力提升 | 高等级任务成功率 > 低等级 | 评估分数 |
