# 系统合并说明

## 合并内容

已将两个进化系统合并为统一入口 **start.py**

## 对比表

| 特性 | 旧 goal_evolution.py | 新 start.py（合并后） |
|------|-------------------|---------------------|
| **运行模式** | 前台单线程，阻塞式 | 后台线程 + 交互式命令 |
| **输出方式** | 仅控制台 print | 控制台 + logging 日志文件 |
| **进化模式** | simple/iterative | simple/iterative（默认iterative） |
| **手动控制** | 无，启动后自动执行全部目标 | 支持，可随时输入命令 |
| **暂停/恢复** | 不支持（Ctrl+C退出） | 支持 pause/resume 命令 |
| **实时查询** | 不支持 | 支持 status/goals/list 等命令 |
| **能力管理** | 不支持 | 支持 enable/disable/info 命令 |
| **队列任务** | 不支持 | 支持 queue/evolve 命令 |
| **系统监控** | 不启动监控模块 | 启动核心监控（CPU/内存） |
| **日志持久化** | 无 | 写入 prokaryote_agent/log/prokaryote.log |
| **空闲优化** | 支持 | 支持（继承） |
| **能力复用** | 支持 | 支持（继承） |

## 功能继承

✅ **完全继承** goal_evolution.py 的核心功能：
1. ✅ 迭代式进化系统（IterativeEvolver）
2. ✅ 目标管理（EvolutionGoalManager）
3. ✅ 多阶段渐进式开发
4. ✅ 自动复杂度评估
5. ✅ 验收标准自动标记
6. ✅ 能力复用机制
7. ✅ 空闲时自动优化

✨ **新增功能**：
1. ✨ 后台持续进化线程
2. ✨ 交互式命令界面
3. ✨ 日志文件持久化
4. ✨ 实时状态查询
5. ✨ 灵活的进化控制（暂停/恢复/立即执行）
6. ✨ 系统监控集成
7. ✨ 进化历史记录
8. ✨ 线程安全输出

## 迁移指南

### 旧命令 → 新命令

| 旧方式 | 新方式 |
|--------|--------|
| `python goal_evolution.py` | `python start.py` |
| `python goal_evolution.py --mode iterative` | `python start.py --mode iterative` |
| `python goal_evolution.py --interval 30` | `python start.py --interval 30` |
| 查看进度：无法查看 | 启动后输入 `goals` |
| 查看能力：无法查看 | 启动后输入 `list` |
| 暂停：Ctrl+C退出 | 输入 `pause` |
| 添加任务：编辑md文件后重启 | 输入 `queue <描述>` |

### 代码级别迁移

如需在代码中使用进化功能：

```python
# ❌ 旧方式
from goal_evolution import GoalDrivenAgent
agent = GoalDrivenAgent(interval=5)
agent.initialize()
agent.run()  # 阻塞主线程

# ✅ 新方式
from start import HybridAgent
agent = HybridAgent(auto_interval=60)
agent.initialize()  # 初始化，启动后台线程
# 后台自动运行，主线程可做其他事
agent.run_command_loop()  # 可选：启动交互界面
```

## 文件变更

### 新增文件
- `docs/启动说明.md` - 完整的使用文档
- `docs/系统合并说明.md` - 本文件

### 修改文件
- `start.py` - 集成迭代式进化系统
  - 新增导入：`IterativeEvolver`, `EvolutionGoalManager`, `CapabilityGenerator`
  - 新增方法：`_initialize_iterative_evolver()`
  - 重写方法：`_select_evolution_target()`, `_evolve_once()`
  - 新增命令：`goals`
  - 增强日志：logging.info 输出进化详情

### 保留文件
- `goal_evolution.py` - 仍可独立使用（仅前台模式）
- `evolution_goals.md` - 两个系统共享目标文件

## 优势说明

### 1. 更好的可观测性

**旧系统**：
```
python goal_evolution.py
# ... 等待完成（无法查看状态）
# 完成后退出
```

**新系统**：
```bash
python start.py
# 后台运行，随时查询：
prokaryote> goals      # 查看目标进度
prokaryote> status     # 查看系统状态
prokaryote> list       # 查看所有能力
```

### 2. 更高的灵活性

**旧系统**：
- 只能在启动前配置
- 执行期间无法干预
- 要添加任务必须重启

**新系统**：
- 运行时暂停/恢复
- 运行时插入优先任务
- 运行时调整配置
- 支持长期运行

### 3. 更完善的日志

**旧系统**：
```
# 只有控制台输出，关闭终端后无法查看历史
```

**新系统**：
```bash
# 终端实时显示 + 日志文件持久化
Get-Content prokaryote_agent/log/prokaryote.log | Select-String "进化"
```

### 4. 更好的资源利用

**旧系统**：
- 执行完所有目标后退出
- CPU空闲时不做任何事

**新系统**：
- 持续运行，按间隔进化
- 无新目标时自动优化已有能力
- 可作为长期运行的服务

## 向后兼容

✅ `goal_evolution.py` 仍可独立运行，适用于：
- 只需执行一次进化任务
- 不需要后台服务
- CI/CD 流程集成
- 脚本化调用

✅ `evolution_goals.md` 格式不变，两系统共用

✅ 所有配置参数向后兼容

## 推荐使用场景

### 使用 start.py（推荐）
✅ 开发环境长期运行  
✅ 需要实时监控进化进度  
✅ 需要手动干预和控制  
✅ 需要查看历史日志  
✅ 需要系统监控集成  

### 使用 goal_evolution.py
✅ 一次性批量进化任务  
✅ CI/CD 自动化流程  
✅ 脚本化调用  
✅ 资源受限环境（无需监控模块）  

## 技术细节

### 线程模型

```
start.py
├─ 主线程（交互式命令循环）
│  └─ 处理用户输入
│  └─ 执行查询命令
│  └─ 手动进化任务
│
└─ 后台线程（自动进化循环）
   └─ 定期检查目标
   └─ 执行迭代式进化
   └─ 记录日志
```

### 日志输出策略

- **后台进化**: 使用 `logging.info()` + `_safe_print()`（线程安全）
- **手动命令**: 使用 `print()`（主线程独占）
- **日志文件**: 所有 logging 自动写入文件
- **控制台**: 实时显示关键信息

### 锁机制

```python
# 防止后台线程和手动命令同时进化
with self.auto_thread_lock:
    self._evolve_once(goal, is_auto=False)
```

### 信号处理

- 初始化期间：忽略 SIGINT（避免 logging 中断）
- 命令循环期间：忽略 SIGINT（使用 quit 命令退出）
- 使用 quit/exit 命令：优雅关闭所有线程

## 测试验证

### 基础功能测试

```bash
# 1. 导入测试
python -c "from start import HybridAgent; print('✓ 导入成功')"

# 2. 帮助测试
python start.py --help

# 3. 目标加载测试
python -c "from start import HybridAgent; a=HybridAgent(); a.goal_manager.load_goals(); print('✓ 目标加载成功')"
```

### 集成测试

```bash
# 启动系统（快速退出）
python start.py &
# 等待3秒
sleep 3
# 检查日志
Get-Content prokaryote_agent/log/prokaryote.log -Tail 20
```

## 常见问题

### Q: 旧的 goal_evolution.py 会被删除吗？

A: 不会。保留作为轻量级选项，适合脚本化使用。

### Q: 如何只使用迭代式进化，不要后台线程？

A: 使用 `goal_evolution.py --mode iterative`

### Q: start.py 的日志在哪里？

A: `prokaryote_agent/log/prokaryote.log`

### Q: 如何切换进化模式？

A: 启动时指定 `python start.py --mode simple` 或 `--mode iterative`

### Q: 后台进化和手动 evolve 冲突吗？

A: 不会，使用线程锁保证串行执行。

## 总结

✅ **完整继承** goal_evolution.py 的所有核心功能  
✅ **显著增强** 可观测性、可控性、持久化  
✅ **向后兼容** 旧系统仍可独立使用  
✅ **统一入口** start.py 成为主要启动方式  
✅ **生产就绪** 支持长期运行、日志记录、优雅关闭  

**推荐使用 `python start.py` 作为日常开发的主要入口！**
