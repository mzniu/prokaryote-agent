# 自动优化功能说明

## 功能概述

当`evolution_goals.md`中没有待执行的进化目标时，原智Agent会自动扫描已有能力，寻找需要优化的代码并自动进行改进。

## 工作原理

### 1. 触发时机
- evolution_goals.md中所有目标都已完成（status=completed）
- 没有待执行（status=pending）或进行中（status=in_progress）的目标

### 2. 能力评估标准

系统会自动分析每个已生成的能力，评估标准包括：

| 指标 | 扣分 | 说明 |
|------|------|------|
| 代码过于简单（<500行） | -20分 | 功能可能不够完善 |
| 包含TODO/FIXME/BUG注释 | -30分 | 存在未完成的工作 |
| 缺乏错误处理（无try/except） | -25分 | 健壮性不足 |

**总分**: 100分起，扣分后低于80分的能力会被选为优化目标

### 3. 优化策略

选择得分最低的能力，创建优化目标：
- **标题**: "优化能力: {能力名称}"
- **优先级**: medium
- **验收标准**:
  - 改善代码结构和可读性
  - 增强错误处理机制
  - 提高测试覆盖率
  - 优化性能和资源使用

### 4. 迭代优化

使用迭代式进化系统进行优化：
- 自动评估复杂度（Simple/Medium/Complex）
- 分阶段改进（1/3/4个阶段）
- 每阶段3次尝试机会
- 保留最佳版本

## 实际案例

### 测试运行输出

```
======================================================================
  没有待执行的进化目标
  🔍 扫描已有能力，寻找优化机会...
======================================================================

💡 发现优化机会: 优化能力: read_config
   当前测试通过率: 当前质量评分: 70/100
   问题: 包含待办事项
```

系统发现`read_config.py`包含TODO注释，评分70分，自动创建优化目标并开始迭代改进。

## 使用方法

无需额外配置，系统自动运行：

```bash
# 正常启动，当没有新目标时会自动优化
python goal_evolution.py --mode iterative
```

也可以手动测试：

```python
from goal_evolution import GoalDrivenAgent

agent = GoalDrivenAgent()
agent.initialize()

# 查找优化机会
goal = agent._find_optimization_opportunity()
if goal:
    print(f"找到优化目标: {goal.title}")
    print(f"问题: {goal.description}")
```

## 配置选项

可以通过修改`goal_evolution.py`中的评估逻辑自定义：

```python
def _find_optimization_opportunity(self):
    # 调整评分标准
    if code_length < 500:  # 可调整阈值
        score -= 20
    
    if has_todo:  # 可调整扣分
        score -= 30
    
    # 调整触发阈值
    if score < 80:  # 可调整最低分数线
        capabilities_to_optimize.append(...)
```

## 优势

1. **持续改进**: 系统永不闲置，始终在优化
2. **自动发现**: 无需人工标记问题代码
3. **渐进式**: 使用迭代进化确保质量
4. **智能选择**: 优先处理问题最多的能力

## 注意事项

- 优化过程会生成新版本的代码文件
- 原有代码会被覆盖（建议版本控制）
- 优化目标优先级默认为medium
- 不会修改evolution_goals.md文件

## 未来增强

可能的改进方向：
- [ ] 基于测试通过率评分
- [ ] 分析运行时性能指标
- [ ] 用户反馈集成
- [ ] 代码复杂度分析（圈复杂度、认知复杂度）
- [ ] 依赖更新检测
